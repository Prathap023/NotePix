{% extends "base.html" %}

{% block title %}Upload file{% endblock %}

{% block content %}
<h1>Upload Files</h1>

<!-- File Upload Form -->
<form action="{{ url_for('views.upload_photo') }}" method="POST" enctype="multipart/form-data">
    <p style="text-align: center;">Please make sure your file name is less than <br>" 50 characters "</p>
    <input type="file" name="file" accept="image/*, video/*" required>
    <button type="submit" class="btn btn-primary">Upload</button>
    <p style="text-align: center;">docx files will be automatically downloaded when you click on view</p>
</form>

<hr style="background-color: aliceblue;">

<!-- Uploaded Files Display -->
<h2 style="text-align: center;">Uploaded Files</h2>
<div class="uploaded-files-container">
    {% for file in uploaded_files %}
    <div class="uploaded-file-item">
        {% if file.endswith(('jpg', 'jpeg', 'png', 'gif', 'webp', 'webm')) %}
            <img src="{{ url_for('static', filename='uploads/' ~ uid ~ '/' ~ file) }}" alt="{{ file }}">
        {% elif file.endswith('heic') %}
            <!-- HEIC placeholder -->
            <img src="" class="heic-image" data-src="{{ url_for('static', filename='uploads/' ~ uid ~ '/' ~ file) }}" alt="{{ file }}">
            <p class="heic-fallback">Your browser does not support HEIC images.
        {% elif file.endswith(('mp4', 'avi', 'mov')) %}
            <video controls> 
                <source src="{{ url_for('static', filename='uploads/' ~ uid ~ '/' ~ file) }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        {% else %}
            <p>{{ file }}</p>
        {% endif %}

        <!-- File Actions -->
        <div class="file-actions">
            <a href="{{ url_for('views.view_file', filename=file) }}" class="view-btn">View</a>
            <a href="{{ url_for('views.delete_file') }}?file={{ file }}" class="delete-btn"
                onclick="return confirm('Are you sure you want to delete this file?')">Delete</a>
            <a href="{{ url_for('static', filename='uploads/' ~ uid ~ '/' ~ file) }}" class="download-btn"
                download>Download</a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- HEIC Conversion Script -->
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("img.heic-image").forEach(img => {
            let heicSrc = img.getAttribute("data-src");
            
            fetch(heicSrc)
                .then(response => response.blob())
                .then(blob => heic2any({ blob, toType: "image/jpeg" }))
                .then(convertedBlob => {
                    let url = URL.createObjectURL(convertedBlob);
                    img.src = url;
                    img.style.display = "block"; // Show converted image
                    img.nextElementSibling.style.display = "none"; // Hide fallback
                })
                .catch(err => {
                    console.error("HEIC conversion error:", err);
                    img.style.display = "none"; // Hide broken image
                    img.nextElementSibling.style.display = "block"; // Show fallback
                });
        });
    });
</script>

{% endblock %}
